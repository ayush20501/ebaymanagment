<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - eBay Listing Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-900">eBay Listing Manager</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-email" class="text-gray-600"></span>
                    <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Create New Listing</h2>
            <p class="text-gray-600">Fill in the details below to create your AI-powered eBay listing</p>
        </div>

        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
        <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>

        <!-- AI Processing Status -->
        <div id="ai-status" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
                <div>
                    <h3 class="text-sm font-medium text-blue-900">AI Processing Your Listing</h3>
                    <p id="ai-status-text" class="text-sm text-blue-700">Analyzing your product description...</p>
                </div>
            </div>
            <div class="mt-3">
                <div class="bg-white rounded-full h-2">
                    <div id="ai-progress" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <form id="listing-form" class="bg-white rounded-lg shadow p-6">
            <!-- Autofill Button -->
            <div class="mb-6 flex justify-between items-center">
                <button type="button" id="autofill-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Fill Sample Data
                </button>
                <span class="text-sm text-gray-500">Click to autofill with example values</span>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="lg:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Item Description *</label>
                    <textarea id="raw_text" required rows="4" placeholder="Describe your item in detail..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    <p class="text-xs text-gray-500 mt-1">AI will analyze this to extract keywords, generate title, and fill product specifications</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Price (Â£) *</label>
                    <input type="number" id="price_value" step="0.01" min="0.01" required placeholder="0.00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quantity *</label>
                    <input type="number" id="quantity" min="1" value="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Condition *</label>
                    <select id="condition" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select condition...</option>
                        <option value="NEW">New</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Currency *</label>
                    <select id="currency" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="GBP" selected>GBP (Â£)</option>
                    </select>
                </div>
                
                <div class="lg:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Image URLs *</label>
                    <textarea id="images" required rows="3" placeholder="Enter at least one image URL (must start with https://)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Enter one HTTPS URL per line (at least one required)</p>
                </div>

                <!-- AI Options -->
                <div class="lg:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-3">AI Enhancement Options</label>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="use_html_description" checked class="h-4 w-4 text-blue-600 rounded">
                            <span class="ml-2 text-sm text-gray-700">Generate HTML description</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="use_simple_prompt_description" checked class="h-4 w-4 text-blue-600 rounded">
                            <span class="ml-2 text-sm text-gray-700">AI-powered description</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="include_debug" class="h-4 w-4 text-blue-600 rounded">
                            <span class="ml-2 text-sm text-gray-700">Show debug info</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="mt-6">
                <button type="submit" id="publish-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                    Publish to eBay
                </button>
            </div>
        </form>

        <!-- Debug Information Panel -->
        <div id="debug-panel" class="hidden mt-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Debug Information</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">AI Keyword Extraction</h4>
                    <div id="debug-keywords" class="bg-white p-3 rounded border text-sm text-gray-600"></div>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">Category Detection</h4>
                    <div id="debug-category" class="bg-white p-3 rounded border text-sm text-gray-600"></div>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">Product Aspects</h4>
                    <div id="debug-aspects" class="bg-white p-3 rounded border text-sm text-gray-600"></div>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">Generated Description</h4>
                    <div id="debug-description" class="bg-white p-3 rounded border text-sm text-gray-600 max-h-40 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication on page load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/auth-status');
                const data = await response.json();
                
                if (!data.is_logged_in) {
                    window.location.href = 'login.html';
                    return;
                } else if (!data.has_profile) {
                    window.location.href = 'profile.html';
                    return;
                } else if (!data.has_ebay_auth) {
                    window.location.href = 'ebay-auth.html';
                    return;
                }
                
                document.getElementById('user-email').textContent = data.email;
            } catch (error) {
                window.location.href = 'login.html';
            }
        });

        // AI Status Management
        const aiStatusEl = document.getElementById('ai-status');
        const aiStatusTextEl = document.getElementById('ai-status-text');
        const aiProgressEl = document.getElementById('ai-progress');

        function showAIStatus(message, progress = 0) {
            aiStatusEl.classList.remove('hidden');
            aiStatusTextEl.textContent = message;
            aiProgressEl.style.width = `${progress}%`;
        }

        function hideAIStatus() {
            aiStatusEl.classList.add('hidden');
            aiProgressEl.style.width = '0%';
        }

        function updateAIProgress(message, progress) {
            aiStatusTextEl.textContent = message;
            aiProgressEl.style.width = `${progress}%`;
        }

        // Autofill functionality
        document.getElementById('autofill-btn').addEventListener('click', () => {
            document.getElementById('raw_text').value = "Sainsbury's Mackerel Fillets in Olive Oil 125g - Premium quality mackerel fillets preserved in olive oil. Perfect for sandwiches, salads, or as a healthy snack. Rich in omega-3 fatty acids and protein. Best before date clearly marked on tin.";
            document.getElementById('price_value').value = "19.99";
            document.getElementById('quantity').value = "3";
            document.getElementById('condition').value = "NEW";
            document.getElementById('images').value = "https://assets.sainsburys-groceries.co.uk/gol/1261448/1/640x640.jpg";
            
            // Clear any error messages
            document.getElementById('error-message').classList.add('hidden');
            document.getElementById('success-message').classList.add('hidden');
            document.getElementById('debug-panel').classList.add('hidden');
            
            // Add a subtle animation to show the form has been filled
            const form = document.getElementById('listing-form');
            form.style.transform = 'scale(1.01)';
            form.style.transition = 'transform 0.2s ease';
            setTimeout(() => {
                form.style.transform = 'scale(1)';
            }, 200);
        });

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await fetch('/logout', { method: 'POST' });
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        });

        // Enhanced form submission with AI status tracking
        document.getElementById('listing-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Additional validation for images - now compulsory
            const imagesValue = document.getElementById('images').value.trim();
            const validImages = imagesValue
                .split('\n')
                .map(url => url.trim())
                .filter(url => url.startsWith('https://'));
            
            if (!imagesValue || validImages.length === 0) {
                document.getElementById('error-message').textContent = 'At least one valid HTTPS image URL is required.';
                document.getElementById('error-message').classList.remove('hidden');
                document.getElementById('success-message').classList.add('hidden');
                return;
            }
            
            const formData = {
                raw_text: document.getElementById('raw_text').value.trim(),
                price: {
                    value: parseFloat(document.getElementById('price_value').value),
                    currency: document.getElementById('currency').value
                },
                quantity: parseInt(document.getElementById('quantity').value),
                condition: document.getElementById('condition').value,
                images: validImages,
                use_html_description: document.getElementById('use_html_description').checked,
                use_simple_prompt_description: document.getElementById('use_simple_prompt_description').checked,
                include_debug: document.getElementById('include_debug').checked
            };
            
            const button = document.getElementById('publish-btn');
            button.disabled = true;
            
            // Hide previous messages and debug panel
            document.getElementById('error-message').classList.add('hidden');
            document.getElementById('success-message').classList.add('hidden');
            document.getElementById('debug-panel').classList.add('hidden');
            
            // Start AI processing animation
            showAIStatus('ðŸ¤– Analyzing your product description...', 10);
            
            try {
                // Simulate AI processing steps for better UX
                setTimeout(() => updateAIProgress('ðŸ” Extracting keywords and metadata...', 25), 500);
                setTimeout(() => updateAIProgress('ðŸ“‚ Finding optimal eBay category...', 50), 1500);
                setTimeout(() => updateAIProgress('ðŸ“‹ Filling product specifications...', 75), 2500);
                setTimeout(() => updateAIProgress('âœï¸ Generating marketing description...', 90), 3500);
                
                const response = await fetch('/publish-item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    updateAIProgress('âœ… Publishing to eBay...', 100);
                    
                    // Show debug information if requested
                    if (formData.include_debug && data.debug) {
                        showDebugInfo(data.debug);
                    }
                    
                    setTimeout(() => {
                        hideAIStatus();
                        // Store success data for success page
                        localStorage.setItem('listing-success', JSON.stringify(data));
                        window.location.href = 'success.html';
                    }, 1000);
                } else {
                    hideAIStatus();
                    document.getElementById('error-message').textContent = data.error || 'Failed to publish listing';
                    document.getElementById('error-message').classList.remove('hidden');
                }
            } catch (error) {
                hideAIStatus();
                document.getElementById('error-message').textContent = 'Network error. Please try again.';
                document.getElementById('error-message').classList.remove('hidden');
            }
            
            button.disabled = false;
        });

        // Show debug information
        function showDebugInfo(debug) {
            document.getElementById('debug-panel').classList.remove('hidden');
            
            // Keywords
            if (debug.step1_extract_keywords) {
                const keywords = debug.step1_extract_keywords;
                document.getElementById('debug-keywords').innerHTML = `
                    <strong>Title:</strong> ${keywords.normalized_title || 'N/A'}<br>
                    <strong>Category Keywords:</strong> ${(keywords.category_keywords || []).join(', ') || 'N/A'}<br>
                    <strong>Brand:</strong> ${keywords.brand || 'N/A'}
                `;
            }
            
            // Category
            if (debug.step2_category) {
                const category = debug.step2_category;
                document.getElementById('debug-category').innerHTML = `
                    <strong>Query:</strong> ${category.queryUsed || 'N/A'}<br>
                    <strong>Category:</strong> ${category.categoryName || 'N/A'}<br>
                    <strong>ID:</strong> ${category.categoryId || 'N/A'}
                `;
            }
            
            // Aspects
            if (debug.step3_aspects) {
                const aspects = debug.step3_aspects;
                const filledAspects = Object.entries(aspects.filled || {})
                    .map(([key, value]) => `${key}: ${Array.isArray(value) ? value.join(', ') : value}`)
                    .join('<br>');
                document.getElementById('debug-aspects').innerHTML = `
                    <strong>Required:</strong> ${(aspects.requiredAspects || []).join(', ') || 'None'}<br>
                    <strong>Filled:</strong><br>${filledAspects || 'None'}
                `;
            }
            
            // Description
            if (debug.description) {
                const desc = debug.description;
                document.getElementById('debug-description').innerHTML = `
                    <strong>HTML Mode:</strong> ${desc.used_html ? 'Yes' : 'No'}<br>
                    <strong>Preview:</strong><br>
                    <div class="mt-2 p-2 bg-gray-100 rounded text-xs">${desc.text.substring(0, 200)}...</div>
                `;
            }
        }
    </script>
</body>
</html>
